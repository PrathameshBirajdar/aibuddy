<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AI Learning Buddy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            font-family: "Comic Sans MS", cursive, sans-serif;
            background: linear-gradient(#e0f7fa, #bbdefb);
            color: #333;
            text-align: center;
        }

        header {
            background: #2196f3;
            color: white;
            padding: 18px;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .tabs {
            margin-top: 40px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
        }

        .tab {
            width: 230px;
            padding: 16px;
            border-radius: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }

        .red {
            background: #f44336;
        }

        .blue {
            background: #2196f3;
        }

        .pink {
            background: #e91e63;
        }

        .yellow {
            background: #fdd835;
            color: black;
        }

        .brown {
            background: #8d6e63;
        }

        .green {
            background: #43a047;
        }

        .purple {
            background: #8e24aa;
        }

        .orange {
            background: #fb8c00;
        }

        /* ---- Chat Popup ---- */
        #chatButton {
            position: fixed;
            right: 25px;
            bottom: 25px;
            background: #2f80ed;
            color: white;
            border: none;
            padding: 16px 18px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 9999;
        }

        #chatModal {
            display: none;
            position: fixed;
            right: 25px;
            bottom: 90px;
            width: 360px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            z-index: 10000;
        }

        #chatHeader {
            background: #2f80ed;
            color: white;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chatBody {
            height: 320px;
            overflow-y: auto;
            padding: 10px;
            background: #f7f8fb;
        }

        #chatInputWrap {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: white;
        }

        #chatInput {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .bubble {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 12px;
            margin: 6px 0;
            max-width: 80%;
            word-wrap: break-word;
        }

        .msg.user {
            text-align: right;
        }

        .bubble.user {
            background: #2f80ed;
            color: white;
        }

        .bubble.bot {
            background: #eef2ff;
            color: #111;
        }
    </style>
</head>

<body>
    <header>🌟 AI Learning Buddy 🌟</header>

    <div class="tabs">
        <div class="tab red">Alphabets</div>
        <div class="tab blue">Numbers (1–100)</div>
        <div class="tab pink">Animals & Birds</div>
        <div class="tab yellow">Fruits & Flowers</div>
        <div class="tab brown">Story Time</div>
        <div class="tab green">General Knowledge</div>
        <div class="tab purple">Ask Me Anything</div>
        <div class="tab orange">Play Quiz</div>
    </div>

    <!-- Chatbot popup -->
    <button id="chatButton">💬</button>
    <div id="chatModal">
        <div id="chatHeader">
            <span>AI Buddy</span>
            <button id="closeBtn" style="background:none;border:none;color:white;font-size:18px;">✖</button>
        </div>
        <div id="chatBody"></div>
        <div id="chatInputWrap">
            <input id="chatInput" type="text" placeholder="Say hi...">
            <button id="sendBtn">Send</button>
        </div>
    </div>

    {% csrf_token %}

    <script>
        const baseURL = window.location.origin;
        const apiURL = `${baseURL}/chat/api/chat/`;

        const chatButton = document.getElementById("chatButton");
        const chatModal = document.getElementById("chatModal");
        const closeBtn = document.getElementById("closeBtn");
        const sendBtn = document.getElementById("sendBtn");
        const chatInput = document.getElementById("chatInput");
        const chatBody = document.getElementById("chatBody");

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie("csrftoken");

        chatButton.onclick = () => chatModal.style.display = "block";
        closeBtn.onclick = () => chatModal.style.display = "none";

        function appendMessage(text, who = "bot") {
            const div = document.createElement("div");
            div.className = who === "user" ? "msg user" : "msg bot";
            const bubble = document.createElement("div");
            bubble.className = "bubble " + (who === "user" ? "user" : "bot");
            bubble.textContent = text;
            div.appendChild(bubble);
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
            return bubble;
        }

        async function sendMessage() {
            const msg = chatInput.value.trim();
            if (!msg) return;
            appendMessage(msg, "user");
            chatInput.value = "";
            const loading = appendMessage("🤔 Thinking...", "bot");
            try {
                const res = await fetch(apiURL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },
                    body: JSON.stringify({ message: msg })
                });
                const data = await res.json();
                loading.textContent = data.response || data.error || "⚠️ No response";
            } catch (err) {
                loading.textContent = "❌ Network error – check connection";
            }
        }
        sendBtn.onclick = sendMessage;
        chatInput.addEventListener("keydown", e => e.key === "Enter" && sendMessage());
    </script>
</body>

</html>