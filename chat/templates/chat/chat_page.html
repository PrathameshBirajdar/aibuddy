{% load static %}
<div id="ai-buddy-popup" aria-live="polite" style="position: fixed; right: 20px; bottom: 20px; z-index: 99999;">
    <!-- ğŸ§  Floating button -->
    <button id="ai-buddy-open" title="Open AI Buddy"
        style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #2f80ed, #7b61ff);
        color: #fff; font-size: 26px; border: none; box-shadow: 0 6px 20px rgba(0,0,0,.25); cursor: pointer;">ğŸ¤–</button>

    <!-- ğŸ’¬ Chat modal -->
    <div id="ai-buddy-modal" style="display:none; width:360px; background:#fff; border-radius:12px; box-shadow:0 16px 40px rgba(0,0,0,.3);
        position: absolute; bottom: 70px; right: 0;">

        <!-- ğŸŸ£ Header -->
        <div style="background: linear-gradient(90deg,#2f80ed,#7b61ff); padding: 12px; color: #fff;
            border-top-left-radius: 12px; border-top-right-radius: 12px;
            display:flex; justify-content: space-between; align-items: center;">
            <strong>AI Buddy</strong>
            <button id="ai-buddy-close"
                style="background:none; border:none; color:#fff; font-size:20px; cursor:pointer;">âœ–</button>
        </div>

        <!-- ğŸ’­ Message area -->
        <div id="ai-buddy-body" style="height:320px; overflow-y:auto; padding:10px; background:#f8f9ff;">
            <div style="text-align:center; color:#777; font-size:14px;">ğŸ‘‹ Hi there! Iâ€™m your AI Buddy. Ask me anything!
            </div>
        </div>

        <!-- âŒ¨ï¸ Input area -->
        <div style="display:flex; gap:8px; padding:10px; align-items:center; border-top:1px solid #eee;">
            <input id="ai-buddy-input" type="text" placeholder="Ask me anything..."
                style="flex:1; padding:8px; border-radius:8px; border:1px solid #ddd;">
            <select id="ai-buddy-context" title="Mode" style="border-radius:6px; border:1px solid #ddd;">
                <option value="general">General</option>
                <option value="english">English</option>
                <option value="math">Math</option>
                <option value="gk">GK</option>
                <option value="quiz">Quiz</option>
                <option value="stories">Stories</option>
                <option value="alphabets">Alphabets</option>
                <option value="numbers">Numbers</option>
                <option value="animals">Animals</option>
                <option value="image">Generate Image ğŸ–¼ï¸</option>
            </select>
            <button id="ai-buddy-send"
                style="background:#2f80ed; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Send</button>
        </div>
    </div>
</div>

<!-- âœ… Working JS (loads after DOM) -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const openBtn = document.getElementById('ai-buddy-open');
        const modal = document.getElementById('ai-buddy-modal');
        const closeBtn = document.getElementById('ai-buddy-close');
        const sendBtn = document.getElementById('ai-buddy-send');
        const input = document.getElementById('ai-buddy-input');
        const body = document.getElementById('ai-buddy-body');
        const context = document.getElementById('ai-buddy-context');

        // ğŸ’¬ Message rendering helper
        function appendMessage(text, who = 'bot') {
            const wrapper = document.createElement('div');
            wrapper.style.margin = '8px 0';
            const bubble = document.createElement('div');
            bubble.textContent = text;
            bubble.style.padding = '8px 12px';
            bubble.style.borderRadius = '12px';
            bubble.style.maxWidth = '80%';
            bubble.style.wordWrap = 'break-word';
            bubble.style.display = 'inline-block';
            bubble.style.clear = 'both';

            if (who === 'user') {
                bubble.style.background = '#2f80ed';
                bubble.style.color = '#fff';
                bubble.style.float = 'right';
            } else {
                bubble.style.background = '#eef2ff';
                bubble.style.color = '#111';
                bubble.style.float = 'left';
            }

            wrapper.appendChild(bubble);
            body.appendChild(wrapper);
            body.scrollTop = body.scrollHeight;
        }

        // ğŸ§  Send message logic
        async function sendMessage() {
            const msg = input.value.trim();
            if (!msg) return;
            appendMessage(msg, 'user');
            input.value = '';
            const loading = appendMessage('ğŸ¤” Thinking...', 'bot');

            try {
                const resp = await fetch("{% url 'chat:chat_api' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msg,
                        name: 'Buddy',
                        context: context.value
                    })
                });
                const data = await resp.json();
                if (data.image_url) {
                    loading.remove();
                    const img = document.createElement('img');
                    img.src = data.image_url;
                    img.alt = "Generated image";
                    img.style.maxWidth = "100%";
                    img.style.borderRadius = "10px";
                    appendMessage("ğŸ–¼ï¸ Here's what I imagined!", "bot");
                    body.appendChild(img);
                } else if (data.response) {
                    loading.textContent = data.response;
                } else {
                    loading.textContent = data.error || 'âš ï¸ Something went wrong.';
                }
            } catch (err) {
                loading.textContent = 'âŒ Connection error. Try again!';
            }
        }

        // ğŸ§© Toggle modal
        openBtn.addEventListener('click', () => {
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        });
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
    });
</script>