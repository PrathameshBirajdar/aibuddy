{% load static %}
<!-- AI Buddy Chat Popup Component -->

<style>
    #chatButton {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #2f80ed;
        color: white;
        border: none;
        padding: 16px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        z-index: 9999;
    }

    #chatModal {
        display: none;
        position: fixed;
        right: 20px;
        bottom: 90px;
        width: 360px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        overflow: hidden;
        z-index: 10000;
        font-family: "Comic Sans MS", cursive, sans-serif;
    }

    #chatHeader {
        background: #2f80ed;
        color: white;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #chatBody {
        height: 320px;
        overflow-y: auto;
        padding: 10px;
        background: #f7f8fb;
    }

    #chatInputWrap {
        display: flex;
        gap: 8px;
        padding: 10px;
    }

    #chatInput {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 8px;
    }

    .bubble {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 12px;
        margin: 6px 0;
        max-width: 80%;
        word-wrap: break-word;
    }

    .msg.user {
        text-align: right;
    }

    .bubble.user {
        background: #2f80ed;
        color: white;
    }

    .bubble.bot {
        background: #eef2ff;
        color: #111;
    }
</style>

<!-- Floating Chat Button -->
<button id="chatButton">💬</button>

<!-- Chat Modal -->
<div id="chatModal">
    <div id="chatHeader">
        <span>AI Buddy</span>
        <button id="closeBtn" style="background:none;border:none;color:white;font-size:18px;">✖</button>
    </div>
    <div id="chatBody"></div>
    <div id="chatInputWrap">
        <input id="chatInput" type="text" placeholder="Say hi...">
        <button id="sendBtn">Send</button>
    </div>
</div>

{% csrf_token %}

<script>
    const apiURL = `${window.location.origin}/chat/api/chat/`;
    const chatButton = document.getElementById("chatButton");
    const chatModal = document.getElementById("chatModal");
    const closeBtn = document.getElementById("closeBtn");
    const sendBtn = document.getElementById("sendBtn");
    const chatInput = document.getElementById("chatInput");
    const chatBody = document.getElementById("chatBody");

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    chatButton.onclick = () => chatModal.style.display = "block";
    closeBtn.onclick = () => chatModal.style.display = "none";

    function appendMessage(text, who = "bot") {
        const div = document.createElement("div");
        div.className = who === "user" ? "msg user" : "msg bot";
        const bubble = document.createElement("div");
        bubble.className = "bubble " + (who === "user" ? "user" : "bot");
        bubble.textContent = text;
        div.appendChild(bubble);
        chatBody.appendChild(div);
        chatBody.scrollTop = chatBody.scrollHeight;
        return bubble;
    }

    async function sendMessage() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        appendMessage(msg, "user");
        chatInput.value = "";
        const loading = appendMessage("🤔 Thinking...", "bot");

        try {
            const res = await fetch(apiURL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();
            loading.textContent = data.response || data.error || "⚠️ No reply";
        } catch (err) {
            loading.textContent = "❌ Connection error — try again.";
        }
    }
    sendBtn.onclick = sendMessage;
    chatInput.addEventListener("keydown", e => e.key === "Enter" && sendMessage());
</script>