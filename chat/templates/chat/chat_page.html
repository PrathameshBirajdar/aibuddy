<!-- aibuddy/chat/templates/chat/chat_page.html -->
{% load static %}
<div id="ai-buddy-popup" aria-live="polite" style="position: fixed; right:20px; bottom:20px; z-index:9999;">
    <!-- Small floating button opens the chat -->
    <button id="ai-buddy-open" title="Open AI Buddy"
        style="width:56px; height:56px; border-radius:50%; background:#2f80ed; color:#fff; border: none; box-shadow: 0 4px 16px rgba(0,0,0,.2);">ðŸ¤–</button>

    <!-- Chat modal -->
    <div id="ai-buddy-modal"
        style="display:none; width:360px; background:#fff; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,.25); margin-top:12px;">
        <div
            style="background:linear-gradient(90deg,#2f80ed,#7b61ff); padding:10px; color:#fff; border-top-left-radius:10px; border-top-right-radius:10px; display:flex; justify-content:space-between; align-items:center;">
            <strong>AI Buddy</strong>
            <button id="ai-buddy-close" style="background:none;border:none;color:#fff;font-size:18px;">âœ–</button>
        </div>
        <div id="ai-buddy-body" style="height:320px; overflow:auto; padding:12px; background:#f7f8fb;"></div>
        <div style="display:flex; gap:8px; padding:10px; align-items:center;">
            <input id="ai-buddy-input" type="text" placeholder="Ask me anything..."
                style="flex:1; padding:8px; border-radius:8px; border:1px solid #ddd;">
            <select id="ai-buddy-context" title="Mode" style="border-radius:6px;">
                <option value="general">General</option>
                <option value="english">English</option>
                <option value="math">Math</option>
                <option value="gk">GK</option>
                <option value="quiz">Quiz</option>
                <option value="stories">Stories</option>
                <option value="alphabets">Alphabets</option>
                <option value="numbers">Numbers</option>
                <option value="animals">Animals</option>
            </select>
            <button id="ai-buddy-send"
                style="background:#2f80ed;color:#fff;border:none;padding:8px 12px;border-radius:8px;">Send</button>
        </div>
    </div>
</div>

<script>
    (function () {
        const openBtn = document.getElementById('ai-buddy-open');
        const modal = document.getElementById('ai-buddy-modal');
        const closeBtn = document.getElementById('ai-buddy-close');
        const sendBtn = document.getElementById('ai-buddy-send');
        const input = document.getElementById('ai-buddy-input');
        const body = document.getElementById('ai-buddy-body');
        const context = document.getElementById('ai-buddy-context');

        function append(text, who = 'bot') {
            const el = document.createElement('div');
            el.style.margin = '8px 0';
            const bubble = document.createElement('div');
            bubble.textContent = text;
            bubble.style.display = 'inline-block';
            bubble.style.padding = '8px 12px';
            bubble.style.borderRadius = '12px';
            bubble.style.maxWidth = '80%';
            if (who === 'user') {
                bubble.style.background = '#2f80ed';
                bubble.style.color = '#fff';
                bubble.style.float = 'right';
            } else {
                bubble.style.background = '#eef2ff';
                bubble.style.color = '#111';
                bubble.style.float = 'left';
            }
            el.appendChild(bubble);
            body.appendChild(el);
            body.scrollTop = body.scrollHeight;
            return bubble;
        }

        async function send() {
            const msg = input.value.trim();
            if (!msg) return;
            append(msg, 'user');
            input.value = '';
            const loading = append('ðŸ¤” Thinking...', 'bot');
            try {
                const resp = await fetch("{% url 'chat:chat_api' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, name: 'Buddy', context: context.value })
                });
                const data = await resp.json();
                if (data.response) loading.textContent = data.response;
                else loading.textContent = data.error || 'âš ï¸ Something went wrong';
            } catch (err) {
                loading.textContent = 'âŒ Connection error. Try again!';
            }
        }

        openBtn.addEventListener('click', () => modal.style.display = 'block');
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        sendBtn.addEventListener('click', send);
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });
    })();
</script>